import requests
from bs4 import BeautifulSoup
import pandas as pd  # <--- ุฌุฏูุฏ: ุงุณุชุฏุนุงุก ููุชุจุฉ ุจุงูุฏุงุณ
import time

# 1. ุงููุงููุณ ุงููุชุฑุฌู: ูุญูู ุงููููุงุช ุฅูู ุฃุฑูุงู
rating_map = {
    'One': 1,
    'Two': 2,
    'Three': 3,
    'Four': 4,
    'Five': 5
}

#  ุฅูุดุงุก ูุงุฆูุฉ ูุงุฑุบุฉ ูุชุฎุฒูู ุงูุจูุงูุงุช
data_list = []  # <--- ุฌุฏูุฏ: ูุฐู ูู "ุงูุณูุฉ"

for page_number in range(1, 51):
    # ููุง ุณูููู ุจุชุบููุฑ ุงูุฑุงุจุท ูู ูู ูุฑุฉ
    url = f"http://books.toscrape.com/catalogue/page-{page_number}.html"
    print(f"ุฌุงุฑู ุณุญุจ ุงูุตูุญุฉ ุฑูู: {page_number}...")

    # ... ุจุนุฏ ุงูุงูุชูุงุก ูู ุณุญุจ ุงูุตูุญุฉ ููุจู ุงูุงูุชูุงู ููุชุงููุฉ ...
    
    time.sleep(1) # <--- ูุงู ููุฏุฉ ุซุงููุฉ ูุงุญุฏุฉ

    # 2. ุฅุฑุณุงู ุงูุทูุจ (ูุฃูู ุถุบุทุช Enter ูู ุงููุชุตูุญ)
    response = requests.get(url)

    # 2. (ููุง ูุถุน ุงูุณุทุฑ ุงูุฌุฏูุฏ) ุฅุฌุจุงุฑ ุงูุชุฑููุฒ ุนูู UTF-8
    response.encoding = 'utf-8'  # <--- ุถุนู ููุง ููุฑุงู



    # ุงูุชุญูู ูู ูุฌุญ ุงูุงุชุตุงูุ (ุฑูู 200 ูุนูู ูุฌุญุ 404 ูุนูู ุบูุฑ ููุฌูุฏ)
    if response.status_code == 200:
        print("ุชู ุงูุงุชุตุงู ุจุงููููุน ุจูุฌุงุญ! โ")

        # 3. ุชุญููู ุงููุต ุงูููุถูู ุฅูู "ุญุณุงุก" (Soup) ูููู ุงูุจุญุซ ููู
        soup = BeautifulSoup(response.text, 'html.parser')

        # 4. ุงูุจุญุซ ุนู ุฌููุน "ุงููุจุณููุงุช" ุงูุชู ุชุญุชูู ุนูู ุงููุชุจ
        # ูุงุญุธุช ุจุงูู Inspect ุฃู ูู ูุชุงุจ ููุฌูุฏ ุฏุงุฎู <article class="product_pod">
        books = soup.find_all('article', class_='product_pod')
        
        print(f"ุชู ุงูุนุซูุฑ ุนูู {len(books)} ูุชุงุจ ูู ูุฐู ุงูุตูุญุฉ.\n")
        print("-" * 40)

        # 5. ุญููุฉ ุชูุฑุงุฑูุฉ ูููุฑูุฑ ุนูู ูู ูุชุงุจ ูุงุณุชุฎุฑุงุฌ ุชูุงุตููู
        for book in books:
            # ุงุณุชุฎุฑุงุฌ ุงูุนููุงู: ููุฌูุฏ ุฏุงุฎู ูุณู h3 ุซู ุฏุงุฎู ูุณู a
            # ูุณุชุฎุฏู attribute 'title' ูุฃูู ูุญุชูู ุงูุงุณู ุงููุงูู ูููุชุงุจ
            title = book.h3.find('a')['title']
            try:
                # ุงุณุชุฎุฑุงุฌ ุงูุณุนุฑ: ููุฌูุฏ ุฏุงุฎู p ููู ููุงุณ price_color
                price = book.find('p', class_='price_color').text
                price = float(price.replace("ยฃ",""))
            except ValueError:
                # ุฅุฐุง ูุดู ุงูุชุญููู (ูุซูุงู ุงูุณุนุฑ ุบูุฑ ููุฌูุฏ ุฃู ูุตู)
                price = 0.0  # ูุถุน ูููุฉ ุงูุชุฑุงุถูุฉ ููู ูุง ุชูุณุฏ ุงูุญุณุงุจุงุช
                print(f"ุชูุจูู: ุชุนุฐุฑ ุชุญููู ุณุนุฑ ุงููุชุงุจ {title}")
            
            # --- ุงูุฌุฒุฆูุฉ ุงูุฌุฏูุฏุฉ: ุณุญุจ ุงูุชูููู ---
            # 1. ูุจุญุซ ุนู ุงูููุฑุฉ ุงูุชู ุชุญุชูู ููุงุณ ุงููุฌูู
            star_tag = book.find('p', class_='star-rating')
            
            # 2. ูุณุชุฎุฑุฌ ุงุณู ุงูููุงุณ (ุณูุนูุฏ ูุงุฆูุฉ ูุซู ['star-rating', 'Three'])
            # ูุฃุฎุฐ ุงูุนูุตุฑ ุงูุซุงูู [1] ูุฃูู ูู ุงูุฐู ูุญุชูู ุนูู ุงูุฑูู ูุชุงุจุฉู
            rating_text = star_tag['class'][1] 
            
            # 3. ูุณุชุฎุฏู ุงููุชุฑุฌู ูุชุญููู ุงููุต ูุฑูู
            rating = rating_map.get(rating_text, 0) # 0 ูู ูู ูุฌุฏ ุดูุฆุงู
            # -----------------------------------
            
            # 3. ุงุณุชุฎุฑุงุฌ ุงูุชููุฑ (ูุน ุงูุชูุธูู)
            availability = book.find('p', class_='instock availability').text.strip()
            
            # ุจุฏูุงู ูู ุงูุทุจุงุนุฉุ ูุถุน ุงูุจูุงูุงุช ูู ูุงููุณ (Dictionary)
            # ุงููุงููุณ ูุดุจู "ุงูุตู" ุงููุงุญุฏ ูู ุงูุฅูุณู (ุนููุงู ุงูุนููุฏ: ุงููููุฉ)
            book_info = {
                'Title': title,
                'Price': price,
                'Rating': rating,  # ุนููุฏ ุฌุฏูุฏ
                'Availability': availability
            } # <--- ุฌุฏูุฏ
            
            # ูุถูู ูุฐุง ุงููุงููุณ ุฅูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
            data_list.append(book_info) # <--- ุฌุฏูุฏ
        
        # --- ุงูุชูุช ุงูุญููุฉ ุงูุชูุฑุงุฑูุฉ ---
    else:
        print("ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงููููุน")

# 4. ุชุญููู ุงููุงุฆูุฉ ุฅูู DataFrame (ุฌุฏูู ุจูุงูุงุช
df = pd.DataFrame(data_list) # <--- ุฌุฏูุฏ

# 5. ุงูุชุตุฏูุฑ ุฅูู ููู Excel
df.to_excel("books_data.xlsx", index=False) # <--- ุฌุฏูุฏ
    
print("ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ ูู ููู books_data.xlsx โ")
print(df.head()) # ุทุจุงุนุฉ ุฃูู 5 ุตููู ููุชุฃูุฏ

# --- ุงูููุณุฉ ุงูุงูุชุตุงุฏูุฉ ---
# ุงูุขู ุจูุง ุฃู ุงูุณุนุฑ ุฃุตุจุญ ุฑููุงูุ ูููููุง ุชุญูููู ููุฑุงู!
average_price = df['Price'].mean() # ุญุณุงุจ ุงููุชูุณุท ุงูุญุณุงุจู
max_price = df['Price'].max()      # ุฃุบูู ูุชุงุจ
min_price = df['Price'].min()      # ุฃุฑุฎุต ูุชุงุจ

print(f"๐ ุชุญููู ุณุฑูุน ููุจูุงูุงุช:")
print(f"ุนุฏุฏ ุงููุชุจ: {len(df)}")
print(f"ูุชูุณุท ุงูุณุนุฑ: ยฃ{average_price:.2f}") # .2f ุชุนูู ุฑูููู ุจุนุฏ ุงููุงุตูุฉ
print(f"ุฃุบูู ูุชุงุจ:   ยฃ{max_price}")
print(f"ุฃุฑุฎุต ูุชุงุจ:   ยฃ{min_price}")

