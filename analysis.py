import pandas as pd

import matplotlib.pyplot as plt  # ุงุณุชุฏุนุงุก ููุชุจุฉ ุงูุฑุณู

import arabic_reshaper
from bidi.algorithm import get_display


# 1. ุชุญููู ุงูุจูุงูุงุช (Load Data)
# ููุฑุฃ ุงูููู ุงูุฐู ุตูุนู ุงูุฑูุจูุช ุงูุฎุงุต ุจูุง
df = pd.read_excel("books_data.xlsx")

print("--- ๐ ุชูุฑูุฑ ุชุญููู ุณูู ุงููุชุจ ---")
print(f"ุฅุฌูุงูู ุงููุชุจ ุงูุชู ุชู ุชุญููููุง: {len(df)}\n")

# ---------------------------------------------------------
# ุงูุชุญููู ุงูุฃูู: ุงูุจุญุซ ุนู "ุงูุฌูุงูุฑ ุงููุฎููุฉ" (Undervalued Assets)
# ---------------------------------------------------------
# ุงูุงุณุชุฑุงุชูุฌูุฉ: ูุฑูุฏ ูุชุจุงู (5 ูุฌูู) ูุณุนุฑูุง (ุฃูู ูู 15 ุฌููู) ููุชููุฑุฉ.

opportunities = df[
    (df['Rating'] == 5) &           # ุงูุดุฑุท 1: ุฃุนูู ุฌูุฏุฉ
    (df['Price'] < 15) &            # ุงูุดุฑุท 2: ุณุนุฑ ุฑุฎูุต ุฌุฏุงู
    (df['Availability'] == 'In stock') # ุงูุดุฑุท 3: ูุชููุฑ ููุดุฑุงุก
]

# ุชุฑุชูุจ ุงููุชุงุฆุฌ: ุงูุฃุฑุฎุต ุฃููุงู
opportunities = opportunities.sort_values(by='Price', ascending=True)

print(f"๐ ูุฌุฏูุง {len(opportunities)} ูุฑุตุฉ ุงุณุชุซูุงุฑูุฉ ุฐูุจูุฉ (5 ูุฌูู ูุฃูู ูู ยฃ15):")
# ุนุฑุถ ุฃูู 5 ูุชุงุฆุฌ ููุท (ุงูุงุณูุ ุงูุณุนุฑุ ุงูุชูููู)
print(opportunities[['Title', 'Price', 'Rating']].head(10))
print("-" * 50)

# ---------------------------------------------------------
# ุงูุชุญููู ุงูุซุงูู: ููู ุชุณุนูุฑ ุงูุณูู (Market Pricing Strategy)
# ---------------------------------------------------------
# ุงูุณุคุงู: ูู ุชุฒูุฏ ุงูุฃุณุนุงุฑ ูููุง ุฒุงุฏ ุงูุชููููุ
# ุณูููู ุจุชุฌููุน ุงููุชุจ ุญุณุจ "ุงููุฌูู" ูุญุณุงุจ ูุชูุณุท ุณุนุฑ ูู ูุฌููุนุฉ.

price_analysis = df.groupby('Rating')['Price'].mean().reset_index()

print("๐ ูุชูุณุท ุงูุณุนุฑ ุญุณุจ ุงูุชูููู:")
# ุชูุณูู ุงูุนุฑุถ ููููู ุฌูููุงู
print(price_analysis.round(2)) # ุชูุฑูุจ ุงูุฃุฑูุงู ูููุฒูุชูู
print("-" * 50)
# ---------------------------------------------------------
#  ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุงูููุงุฆู
# ---------------------------------------------------------
# ุณูุญูุธ "ุงููุฑุต ุงูุฐูุจูุฉ" ูู ููู ูููุตู ููุฑุณูู ููุนููู
opportunities.to_excel("best_deals_report.xlsx", index=False)
print("โ ุชู ุญูุธ ุชูุฑูุฑ ุงููุฑุต ูู ููู 'best_deals_report.xlsx'")

# ุงูุฑุณู

# (ุงูุชุฑุถ ุฃู df ุชู ุชุญูููู ูุญุณุงุจุงุชู ุฌุงูุฒุฉ ูู ุงูููุฏ ุงูุณุงุจู)
# ... ููุฏ ุงูุชุญููู ูุงูุญุณุงุจุงุช ููุง ...
# ููุชุฐููุฑ: ratings_data = df.groupby('Rating')['Price'].mean()

# --- ุฏุงูุฉ ูุฅุตูุงุญ ุงููุบุฉ ุงูุนุฑุจูุฉ ---
def fix_text(text):
    reshaped_text = arabic_reshaper.reshape(text) # ูุดุจู ุงูุญุฑูู
    bidi_text = get_display(reshaped_text)        # ูููุจ ุงูุงุชุฌุงู
    return bidi_text

# ------------------------------------

# ุฅุนุฏุงุฏ ุงูุจูุงูุงุช
ratings_data = df.groupby('Rating')['Price'].mean()

plt.figure(figsize=(10, 6))

# ุฑุณู ุงูุฃุนูุฏุฉ
ratings_data.plot(kind='bar', color='skyblue', edgecolor='black')

# ุงุณุชุฎุฏุงู ุฏุงูุฉ fix_text ูุน ูู ูุต ุนุฑุจู
title = fix_text('ูุชูุณุท ุณุนุฑ ุงููุชุจ ููุงุฑูุฉ ุจุงูุชูููู')
xlabel = fix_text('ุงูุชูููู (ุนุฏุฏ ุงููุฌูู)')
ylabel = fix_text('ูุชูุณุท ุงูุณุนุฑ (ยฃ)')

plt.title(title, fontsize=16)
plt.xlabel(xlabel, fontsize=12)
plt.ylabel(ylabel, fontsize=12)

plt.xticks(rotation=0)
plt.grid(axis='y', linestyle='--', alpha=0.7)

print("ุฌุงุฑู ุนุฑุถ ุงูุฑุณู... ๐")
plt.show()